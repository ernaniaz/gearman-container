#!/bin/bash

echo "                                ░░░░░░      ░░░░"
echo "                        ▒▒░░    ░░░░▒▒    ░░░░░░"
echo "                        ▒▒░░    ▒▒▒▒░░░░  ░░░░░░    ▒▒░░"
echo "                ▒▒▒▒    ▒▒░░░░░░░░▒▒▒▒██▒▒░░░░░░░░░░░░░░"
echo "                ▒▒▒▒▒▒░░░░▓▓▓▓░░░░░░▒▒░░░░░░░░▓▓▒▒░░░░░░    ░░"
echo "                  ▒▒░░▓▓▒▒▒▒░░░░▒▒▒▒░░░░░░░░░░░░▒▒▒▒▒▒░░  ░░░░░░"
echo "          ▒▒▒▒  ░░▒▒▓▓▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░▒▒▓▓░░░░░░"
echo "          ▒▒▓▓░░▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒░░░░"
echo "          ░░░░▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▓▓▓▓▒▒▒▒░░░░  ░░░░░░  ░░▒▒░░░░▒▒▒▒░░"
echo "          ░░░░▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▓░░░░░░▒▒░░░░░░░░▒▒░░  ░░░░░░░░▓▓░░░░▒▒"
echo "    ▒▒▒▒▒▒▒▒▓▓▒▒▒▒░░▒▒▒▒▓▓▒▒▒▒░░░░░░░░▒▒▒▒▒▒▒▒░░░░▒▒  ▒▒░░░░░░▓▓░░"
echo "      ▓▓▒▒▓▓▒▒▒▒▒▒▒▒▒▒▓▓░░░░░░░░░░░░▒▒▒▒░░░░░░░░░░░░▒▒░░▒▒░░░░▒▒░░░░"
echo "        ░░▓▓▒▒▒▒▒▒▒▒▓▓░░░░░░░░▓▓░░░░░░░░░░▒▒▒▒░░░░░░░░▒▒▒▒░░░░░░▓▓░░▒▒▒▒░░"
echo "      ░░▒▒▒▒▓▓▒▒▒▒▒▒▒▒░░▒▒░░▒▒                ▒▒░░░░░░▒▒░░▒▒░░░░▒▒░░▒▒░░"
echo "  ▒▒▓▓░░▓▓▒▒▒▒▒▒▒▒▓▓░░░░░░▒▒                    ▒▒░░░░░░▒▒░░▒▒▒▒▒▒▒▒░░"
echo "  ▒▒▓▓░░▓▓▒▒░░▒▒▒▒▓▓░░░░▒▒░░                    ░░░░░░░░▓▓░░▒▒▒▒▒▒▓▓▒▒"
echo "    ▒▒░░▓▓▒▒▒▒▒▒▒▒▒▒░░░░▒▒                        ▒▒░░░░██░░▒▒▒▒▒▒██▒▒▒▒▒▒"
echo "      ▒▒▒▒▓▓▒▒▒▒▒▒░░░░░░▒▒                        ▒▒░░░░  ▒▒▒▒▒▒▒▒▓▓░░▒▒▒▒"
echo "  ▓▓▓▓░░▒▒▓▓▒▒▒▒▓▓  ░░░░▒▒                        ▒▒░░░░  ▒▒▒▒▒▒▒▒▓▓░░"
echo "░░▓▓▓▓▒▒▒▒▓▓▒▒▒▒▒▒▒▒░░░░▒▒                        ▒▒░░░░▓▓▓▓▒▒▒▒▒▒▓▓▒▒"
echo "    ▓▓░░▒▒▒▒▒▒▒▒▒▒▓▓░░░░▒▒                        ▒▒░░░░██▓▓▒▒▒▒▒▒▓▓▒▒▒▒"
echo "      ░░▒▒▒▒▒▒▒▒▓▓██░░░░░░░░                    ▒▒░░░░░░▓▓▓▓▒▒▒▒▒▒▓▓▒▒▓▓▒▒"
echo "    ░░▒▒▒▒▒▒▓▓▒▒▒▒▓▓░░░░░░▒▒                  ░░░░░░░░▒▒▓▓▓▓▒▒▒▒▓▓▒▒▓▓▓▓▒▒"
echo "    ▓▓██▒▒▓▓▓▓▒▒▓▓▒▒██░░▒▒▒▒▒▒░░              ▒▒▒▒░░░░██▓▓▓▓▒▒▓▓▓▓▒▒"
echo "  ▓▓▓▓▓▓▒▒▓▓▒▒▓▓▒▒▓▓▓▓▒▒▒▒▒▒▒▒░░░░░░░░  ░░▒▒▒▒▒▒▒▒▒▒▓▓▓▓▒▒▒▒▓▓▒▒▓▓▒▒"
echo "        ░░▒▒▓▓▓▓▒▒▓▓▓▓▓▓▒▒▒▒▒▒▒▒░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓██▓▓▓▓▒▒▒▒▓▓▒▒▓▓▓▓"
echo "        ▒▒▒▒▒▒▒▒▓▓▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒████▓▓▒▒▒▒▓▓▒▒██▓▓▓▓▓▓▒▒"
echo "      ░░▓▓▓▓▒▒▒▒▒▒▓▓▒▒▓▓▓▓▓▓██▓▓▓▓▒▒▒▒▒▒▒▒██████▓▓▓▓▒▒▒▒▓▓▒▒▓▓▒▒"
echo "      ▒▒▓▓▒▒▒▒▒▒▒▒▒▒▓▓▒▒▓▓▓▓▒▒▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▒▒▓▓▒▒██"
echo "              ██▒▒░░▒▒▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▓▓▒▒▓▓▓▓▓▓"
echo "              ▓▓▓▓▒▒░░▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▒▒▒▒▒▒▓▓▒▒▒▒  ▓▓▓▓"
echo "            ▒▒▓▓▓▓▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▓▓▒▒▓▓"
echo "              ░░    ▓▓▓▓▒▒▒▒░░▒▒░░▒▒▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓"
echo "                    ▓▓▓▓▒▒  ▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▒▒    ▒▒▒▒"
echo "                    ▓▓▒▒    ▓▓▓▓▒▒  ▒▒▓▓▓▓░░    ▓▓▓▓"
echo "                            ▓▓▒▒      ▒▒▓▓        ░░"
echo
echo "GearmanD 1.1.19.1 - Container by Ernani Azevedo <azevedo@voipdomain.io>"
echo
echo -n -e "Creating configuration file... "

# Internal variables:
CONFIG_FILE="/tmp/gearman.conf"

# External variables:
CONFIG_LISTEN="${GEARMAN_LISTEN:-0.0.0.0}"
CONFIG_PORT="${GEARMAN_PORT:-4730}"
CONFIG_VERBOSE="${GEARMAN_VERBOSE:-INFO}"
CONFIG_QUEUE_TYPE="${GEARMAN_QUEUE_TYPE:-builtin}"
CONFIG_THREADS="${GEARMAN_THREADS:-4}"
CONFIG_BACKLOG="${GEARMAN_BACKLOG:-32}"
CONFIG_FILE_DESCRIPTORS="${CONFIG_FILE_DESCRIPTORS:-0}"
CONFIG_JOB_RETRIES="${GEARMAN_JOB_RETRIES:-0}"
CONFIG_ROUND_ROBIN="${GEARMAN_ROUND_ROBIN:-0}"
CONFIG_WORKER_WAKEUP="${GEARMAN_WORKER_WAKEUP:-0}"
CONFIG_KEEPALIVE="${GEARMAN_KEEPALIVE:-0}"
CONFIG_KEEPALIVE_IDLE="${GEARMAN_KEEPALIVE_IDLE:-30}"
CONFIG_KEEPALIVE_INTERVAL="${GEARMAN_KEEPALIVE_INTERVAL:-10}"
CONFIG_KEEPALIVE_COUNT="${GEARMAN_KEEPALIVE_COUNT:-5}"

# Create configuration file:
echo "--listen=${CONFIG_LISTEN}" > "${CONFIG_FILE}"
echo "--port=${CONFIG_PORT}" >> "${CONFIG_FILE}"
echo "--log-file=stderr" >> "${CONFIG_FILE}"
echo "--verbose=${CONFIG_VERBOSE}" >> "${CONFIG_FILE}"
echo "--queue-type=${CONFIG_QUEUE_TYPE}" >> "${CONFIG_FILE}"
echo "--threads=${CONFIG_THREADS}" >> "${CONFIG_FILE}"
echo "--backlog=${CONFIG_BACKLOG}" >> "${CONFIG_FILE}"
echo "--job-retries=${CONFIG_JOB_RETRIES}" >> "${CONFIG_FILE}"
echo "--worker-wakeup=${CONFIG_WORKER_WAKEUP}" >> "${CONFIG_FILE}"
if [ "${CONFIG_FILE_DESCRIPTORS}" -ne 0 ]; then
  echo "--file-descriptors=${CONFIG_FILE_DESCRIPTORS}" >> "${CONFIG_FILE}"
fi
if [ "${CONFIG_ROUND_ROBIN}" -ne 0 ]; then
  echo "--round-robin" >> "${CONFIG_FILE}"
fi
if [ "${CONFIG_KEEPALIVE}" -ne 0 ]; then
  echo "--keepalive" >> "${CONFIG_FILE}"
  echo "--keepalive-idle=${CONFIG_KEEPALIVE_IDLE}" >> "${CONFIG_FILE}"
  echo "--keepalive-interval=${CONFIG_KEEPALIVE_INTERVAL}" >> "${CONFIG_FILE}"
  echo "--keepalive-count=${CONFIG_KEEPALIVE_COUNT}" >> "${CONFIG_FILE}"
fi
if [ "${CONFIG_QUEUE_TYPE}" == "mysql" ]; then
  echo "--mysql-host=${GEARMAN_MYSQL_HOST:-localhost}" >> "${CONFIG_FILE}"
  echo "--mysql-port=${GEARMAN_MYSQL_PORT:-3306}" >> "${CONFIG_FILE}"
  echo "--mysql-user=${GEARMAN_MYSQL_USER:-root}" >> "${CONFIG_FILE}"
  echo "--mysql-password=${GEARMAN_MYSQL_PASSWORD:-password}" >> "${CONFIG_FILE}"
  echo "--mysql-db=${GEARMAN_MYSQL_DB:-gearmand}" >> "${CONFIG_FILE}"
  echo "--mysql-table=${GEARMAN_MYSQL_TABLE:-gearman_queue}" >> "${CONFIG_FILE}"
fi

echo "OK!"
echo "Starting gearman..."
echo

/usr/sbin/gearmand $(cat "${CONFIG_FILE}")
